#!/usr/bin/env bash

set -euo pipefail

terminal_pid="$(hyprctl activewindow -j | jq -r '.pid // empty' 2>/dev/null || true)"
if [[ -z "$terminal_pid" ]]; then
  printf "%s\n" "$HOME"
  exit 0
fi

shell_pid="$(pgrep -P "$terminal_pid" | tail -n1 || true)"
if [[ -z "$shell_pid" ]]; then
  printf "%s\n" "$HOME"
  exit 0
fi

cwd="$(readlink -f "/proc/$shell_pid/cwd" 2>/dev/null || true)"
shell="$(readlink -f "/proc/$shell_pid/exe" 2>/dev/null || true)"

if grep -qs "$shell" /etc/shells && [[ -d "$cwd" ]]; then
  printf "%s\n" "$cwd"
else
  printf "%s\n" "$HOME"
fi
