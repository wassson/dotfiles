#!/usr/bin/env bash

set -euo pipefail

screensaver_in_focus() {
  hyprctl activewindow -j | jq -e '.class == "org.omarchy.screensaver"' >/dev/null 2>&1
}

exit_screensaver() {
  hyprctl keyword cursor:invisible false >/dev/null 2>&1 || true
  pkill -x tte >/dev/null 2>&1 || true
  pkill -f org.omarchy.screensaver >/dev/null 2>&1 || true
  exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

printf '\033]11;rgb:00/00/00\007'
hyprctl keyword cursor:invisible true >/dev/null 2>&1 || true

tty_name="$(tty 2>/dev/null || true)"
input_text="$HOME/.config/omarchy/branding/screensaver.txt"

if [[ ! -f "$input_text" ]]; then
  input_text="/etc/hostname"
fi

while true; do
  tte -i "$input_text" --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c --random-effect --exclude-effects dev_worm --no-eol --no-restore-cursor &

  while pgrep -t "${tty_name#/dev/}" -x tte >/dev/null 2>&1; do
    if read -n1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done
done
